# File: render.yaml
# Place this in the root directory (same folder as environment.yaml)

services:
  # Main Stable Diffusion API service
  - type: web
    name: stable-diffusion-api
    env: docker
    region: oregon  # or: frankfurt, singapore, ohio
    plan: standard  # $25/month, 2GB RAM (minimum for Stable Diffusion)
    dockerfilePath: ./Dockerfile
    envVars:
      - key: MODEL_NAME
        value: sd-v1-4  # Uses SD v1.4 model
      - key: HF_HOME
        value: /opt/render/.cache/huggingface
      - key: SAFETENSORS_FAST_GPU
        value: "1"
    disk:
      name: model-storage
      mountPath: /opt/render/.cache
      sizeGB: 30  # Models are large (7-14GB each)
    healthCheckPath: /health
    autoDeploy: true  # Auto-deploy when you push to GitHub
    
  # Background worker for image processing (optional)
  - type: worker
    name: image-processor
    env: docker
    dockerfilePath: ./Dockerfile.worker
    plan: starter
    envVars:
      - key: WORKER_TYPE
        value: image_processor
        
  # Cron job for cleanup (optional)
  - type: cron
    name: cleanup-job
    schedule: "0 2 * * *"  # Runs daily at 2 AM UTC
    startCommand: python scripts/cleanup_cache.py --days 7
    plan: starter
